<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Credibe - International Transfer</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
   <script defer src="/assets/gtranslate-init.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #121212;
      color: #e0e0e0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    input, select, textarea {
      background-color: #1f1f1f;
      border-color: #444;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #00b4d8;
      outline: none;
      box-shadow: 0 0 0 1px #00b4d8;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="bg-[#1e1e1e] py-6 px-8 shadow-md flex justify-between items-center">
    <div class="flex items-center space-x-3">
      <img src="credibe.png" alt="Credibe Logo" class="h-9 w-9 sm:h-10 sm:w-10 rounded-full object-contain bg-white p-[2px]" />
      <span class="text-xl sm:text-2xl font-bold text-[#00b4d8] tracking-wide">Credibe</span>
    </div>
    <a href="dashboard.html" class="text-[#00b4d8] hover:text-[#009bc2] text-2xl sm:text-3xl transition" title="Back">‚Üê</a>
  </header>

  <!-- Main Content -->
  <main class="max-w-3xl mx-auto py-12 px-6">
    <h2 class="text-3xl font-bold text-[#00b4d8] mb-6">International Bank Transfer</h2>
    
    <form id="intl-transfer-form" class="grid grid-cols-1 gap-6">
      <div>
        <label class="block mb-2">Bank Name</label>
        <input type="text" id="bank-name" required class="w-full px-4 py-2 rounded-md border" placeholder="e.g. Bank of America" />
      </div>
      <div>
        <label class="block mb-2">Account Holder Name</label>
        <input type="text" id="account-name" required class="w-full px-4 py-2 rounded-md border" placeholder="e.g. John McGuinn" />
      </div>
      <div>
        <label class="block mb-2">Account Type</label>
        <select id="account-type" required class="w-full px-4 py-2 rounded-md border">
          <option value="" disabled selected>Select Type</option>
          <option value="Checking">Checking</option>
          <option value="Savings">Savings</option>
          <option value="Business">Business</option>
        </select>
      </div>
      <div>
        <label class="block mb-2">Account Number</label>
        <input type="text" id="account-number" required class="w-full px-4 py-2 rounded-md border" placeholder="e.g. 1234567890" />
      </div>
      <div>
        <label class="block mb-2">Routing Number</label>
        <input type="text" id="routing-number" required class="w-full px-4 py-2 rounded-md border" placeholder="e.g. 026009593" />
      </div>
      <div>
        <label class="block mb-2">SWIFT / BIC Code</label>
        <input type="text" id="swift" required class="w-full px-4 py-2 rounded-md border" placeholder="e.g. BOFAUS3N" />
      </div>
      <div>
        <label class="block mb-2">Bank Address</label>
        <textarea id="bank-address" required rows="3" class="w-full px-4 py-2 rounded-md border" placeholder="e.g. 123 Main Street, New York, NY, USA"></textarea>
      </div>
      <div>
        <label class="block mb-2">Transfer Amount (eur)</label>
        <input type="number" id="amount" required class="w-full px-4 py-2 rounded-md border" placeholder="e.g. 5000" />
      </div>
      <div>
        <label class="block mb-2">Reference / Purpose</label>
        <input type="text" id="reference" class="w-full px-4 py-2 rounded-md border" placeholder="e.g. Tuition Payment" />
      </div>
      <div id="transferOtpSection" class="hidden">
        <label class="block mb-2">OTP</label>
        <input type="text" id="transfer-otp" class="w-full px-4 py-2 rounded-md border" placeholder="Enter OTP" />
      </div>
      <button type="submit" id="submit-transfer" class="w-full bg-[#00b4d8] hover:bg-[#009bc2] text-white font-semibold py-3 rounded-md mt-4 transition flex items-center justify-center gap-2">
        <span id="submit-text">Initiate Transfer</span>
        <svg id="submit-spinner" class="hidden animate-spin h-5 w-5 text-white" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
        </svg>
      </button>
    </form>
  </main>

    <script>
/* /assets/gtranslate-init.js */
(function(){
  if (window.__GT_LOADED__) return; window.__GT_LOADED__ = true;

  // --- settings ---
  var LANGS = "de,fr,es,it,pt,nl,pl,sv,da,fi,no,tr,cs,ro,hu,el,ar,ru,uk,hi,id,ms,th,vi,ja,ko,zh-CN,zh-TW";
  var PAGE_LANG = "en"; // your default authoring language

  // --- utils ---
  function setCookie(name, value) {
    var d = new Date(); d.setTime(d.getTime() + 365*24*60*60*1000);
    var expires = "expires=" + d.toUTCString();
    document.cookie = name + "=" + value + "; " + expires + "; path=/";
    try {
      var dot = "." + location.hostname.replace(/^www\./,'');
      document.cookie = name + "=" + value + "; " + expires + "; domain=" + dot + "; path=/";
    } catch(e){}
  }
  function getSaved(){
    try {
      var v = localStorage.getItem("g_lang"); if (v) return v;
      var m = document.cookie.match(/(?:^|;\s*)googtrans=([^;]+)/);
      if (m && m[1]) return (m[1].split("/").pop()||"").trim();
    } catch(e){}
    return "";
  }
  function apply(lang){
    var sel = document.querySelector("select.goog-te-combo");
    if (!sel) return false;
    if (sel.value !== lang) {
      sel.value = lang;
      sel.dispatchEvent(new Event("change"));
    }
    return true;
  }

  // --- public API so your own buttons can call it: GTranslate.set('de') ---
  window.GTranslate = {
    set: function(lang){
      if (!lang) return;
      setCookie("googtrans", "/" + PAGE_LANG + "/" + lang);
      try { localStorage.setItem("g_lang", lang); } catch(e){}
      if (!apply(lang)) {
        var tries = 0, t = setInterval(function(){
          if (apply(lang) || ++tries > 40) clearInterval(t);
        }, 250);
      }
      try { window.dispatchEvent(new CustomEvent("gtranslate:change", { detail:{lang} })); } catch(e){}
      try { document.documentElement.setAttribute("lang", lang); } catch(e){}
    },
    get: function(){ return getSaved() || PAGE_LANG; }
  };

  // --- add container (bottom-right bubble) ---
  var wrap = document.getElementById("gtranslate_container");
  if (!wrap) {
    wrap = document.createElement("div");
    wrap.id = "gtranslate_container";
    wrap.style.cssText = "position:fixed;right:16px;bottom:16px;z-index:999999;background:#12161f;"+
                         "border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;color:#fff;"+
                         "box-shadow:0 10px 24px rgba(0,0,0,.35);font:13px system-ui,-apple-system,Segoe UI,Roboto,sans-serif";
    wrap.innerHTML = '<div id="gtranslate_widget" style="display:flex;align-items:center;gap:8px">'+
                     '  <span style="opacity:.8">üåê</span>'+
                     '  <div id="gtranslate_mount"></div>'+
                     '</div>';
    document.documentElement.appendChild(wrap);
  }

  // --- init callback required by Google ---
  window.googleTranslateElementInit = function(){
    new google.translate.TranslateElement({
      pageLanguage: PAGE_LANG,
      includedLanguages: LANGS,
      layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
      autoDisplay: false // no auto-banner on first load unless user picks a language
    }, "gtranslate_mount");

    // Re-apply saved language after widget renders (persisted by us)
    var saved = getSaved();
    if (saved && saved !== PAGE_LANG) {
      setTimeout(function(){ window.GTranslate.set(saved); }, 400);
    }

    // Keep branding minimal but DO NOT hide the top banner so users can close it.
    // (Remove only small gadget text; leave banner visible and functional.)
    var css = document.createElement("style");
    css.textContent =
      /* DO NOT hide .goog-te-banner-frame; let users click ‚úï themselves */
      ".goog-te-gadget span{display:none!important}" +
      ".goog-logo-link{display:none!important}";
      // Note: we also don't force body{top:0} so the banner can push content down until closed.
    document.head.appendChild(css);
  };

  // --- load Google script once ---
  var s = document.createElement("script");
  s.src = "https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit";
  s.async = true;
  document.head.appendChild(s);

  // --- if your pages dynamically change content (SPAs), re-apply on mutations ---
  try {
    var mo = new MutationObserver(function(){
      var saved = getSaved();
      if (saved && saved !== PAGE_LANG) apply(saved);
    });
    mo.observe(document.body, { childList: true, subtree: true });
  } catch(e){}
})();
</script>
  <script>
    const form = document.getElementById("intl-transfer-form");
    const transferOtpSection = document.getElementById("transferOtpSection");
    const submitBtn = document.getElementById("submit-transfer");
    const submitText = document.getElementById("submit-text");
    const submitSpinner = document.getElementById("submit-spinner");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Check if user is blocked in localStorage
      if (localStorage.getItem("isBlocked") === "true") {
        window.location.href = "blocked.html";
        return;
      }

      // Get form details
      const details = {
        bankName: document.getElementById("bank-name").value.trim(),
        accountName: document.getElementById("account-name").value.trim(),
        accountType: document.getElementById("account-type").value,
        accountNumber: document.getElementById("account-number").value.trim(),
        routingNumber: document.getElementById("routing-number").value.trim(),
        swift: document.getElementById("swift").value.trim(),
        bankAddress: document.getElementById("bank-address").value.trim(),
        amount: parseFloat(document.getElementById("amount").value),
        reference: document.getElementById("reference").value.trim(),
        otp: document.getElementById("transfer-otp").value.trim(),
      };

      // Validate inputs
      if (!details.bankName || !details.accountName || !details.accountType || !details.accountNumber || !details.routingNumber || !details.swift || !details.bankAddress || isNaN(details.amount) || details.amount <= 0) {
        alert("Please fill all required fields with valid data.");
        return;
      }

      if (!/^[A-Z]{4}[A-Z]{2}[A-Z0-9]{2,5}$/.test(details.swift)) {
        alert("Invalid SWIFT/BIC format (must be 8 or 11 uppercase letters/digits).");
        return;
      }

      if (!/^\d{9}$/.test(details.routingNumber)) {
        alert("Invalid routing number (must be 9 digits).");
        return;
      }

      // Show spinner
      submitText.classList.add("hidden");
      submitSpinner.classList.remove("hidden");
      submitBtn.disabled = true;

      const token = localStorage.getItem("userToken");

      // Step 1: Request OTP if not provided
      if (!details.otp) {
        try {
          const res = await fetch("https://credibe-backends.onrender.com/api/transfer/send-otp", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify({ type: "transfer" })
          });

          const data = await res.json();
          if (!res.ok) {
            if (data.error === "user blocked") {
              localStorage.setItem("isBlocked", "true");
              window.location.href = "blocked.html";
              return;
            }
            throw new Error(data.error || "Failed to send OTP");
          }

          alert("üì© OTP sent to your email.");
          transferOtpSection.classList.remove("hidden");
        } catch (err) {
          console.error("‚ùå OTP send error:", err.message);
          alert("‚ùå Error sending OTP: " + err.message);
        } finally {
          submitText.classList.remove("hidden");
          submitSpinner.classList.add("hidden");
          submitBtn.disabled = false;
        }
        return;
      }

      // Step 2: Submit Transfer
      try {
        const res = await fetch("https://credibe-backends.onrender.com/api/transfer/initiate", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({
            toIban: details.swift,
            recipient: details.accountName,
            amount: details.amount,
            note: details.reference || "International Transfer",
            otp: details.otp,
            type: "international",
            bankName: details.bankName,
            accountType: details.accountType,
            accountNumber: details.accountNumber,
            routingNumber: details.routingNumber,
            bankAddress: details.bankAddress
          }),
        });

        const data = await res.json();
        if (!res.ok) {
          if (data.error === "user blocked") {
            localStorage.setItem("isBlocked", "true");
            window.location.href = "blocked.html";
            return;
          }
          throw new Error(data.error || "Transfer failed");
        }

        // Save pending transaction for UI
        localStorage.setItem("intlTransferPending", JSON.stringify({
          bankName: details.bankName,
          accountName: details.accountName,
          accountType: details.accountType,
          accountNumber: details.accountNumber,
          routingNumber: details.routingNumber,
          swift: details.swift,
          bankAddress: details.bankAddress,
          amount: details.amount,
          reference: details.reference,
          transferId: data.transactionId
        }));

        window.location.href = "transfer-pending-intl.html";
      } catch (err) {
        console.error("‚ùå Transfer error:", err.message);
        alert("‚ùå Transfer Failed: " + err.message);
      } finally {
        submitText.classList.remove("hidden");
        submitSpinner.classList.add("hidden");
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>